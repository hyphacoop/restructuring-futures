<script>
  import * as Earthstar from "earthstar";

  import { fly } from "svelte/transition";

  import authorKeypair from "./store/identity.js";
  import replicaDetails from "./store/replica.js";
  import settings from "./store/settings.js";
  import shareKeypair from "./store/share.js";
  import { statusStore } from './store/status.js';


  import { onMount } from "svelte";

  import Identity from "./lib/Customization/Identity.svelte";
  import UploadId from "./lib/UploadId.svelte";
  import ValidateId from "./lib/ValidateId.svelte";
  import GridView from "./lib/GridView.svelte";
  import GridUpload from "./lib/GridUpload.svelte";
  import StatusPanel from "./lib/Components/StatusPanel.svelte";
  import ShareSettings from "./lib/ShareSettings.svelte";
  import UserSettings from "./lib/UserSettings.svelte";
  import MouseBanner from "./lib/MouseBanner.svelte";
  import Footer from "./lib/Components/Footer.svelte";

  let IDcreated = false;
  let showDetails = false;
  let imageView = true;
  let showWarning = false;
  let showUserSettings = false;
  let initialView = 'workspace';

  let status = undefined;

  let readManual = false;

  function handleReadManual() {
    readManual = true;
  }

  console.log('settings', settings)

  onMount(async () => {
    if (settings.author) {
      // if an author already exists, use it
      authorKeypair.set(settings.author);
      IDcreated = true;
    } else {
      // if no author exists, generate a new one
      IDcreated = false;
    }
      // Add a share and check the result
      const studioResult = settings.addShare('+studio.bs36kywtfq52ad3upxdjxzdvjwccnwvdg23b3yltpik5jzn5ek3za');
    
    if (Array.isArray(studioResult)) {
      // If the result is an array, the share was added successfully
      settings.addSecret('+studio.bs36kywtfq52ad3upxdjxzdvjwccnwvdg23b3yltpik5jzn5ek3za', 'b7f67r7dhcqxrqgiu4q3zrzuw26lvtqnauigng22na36urhlmywha');
    } else if (studioResult instanceof Earthstar.ValidationError) {
      // Handle the validation error
      console.error("Failed to add share due to validation error:", studioResult.message);
    }

    const shareResult = settings.addShare($shareKeypair.shareAddress);
    if (Array.isArray(shareResult)) {
      settings.addSecret($shareKeypair.shareAddress, $shareKeypair.shareSecret);
    } else if (shareResult instanceof Earthstar.ValidationError) {
      console.error("Failed to add share due to validation error:", shareResult.message);
    }
    console.log('settings', settings)
    console.log('settings.shareSecrets', settings.shareSecrets)
    createNewPeer();
  });

  function createNewPeer() {
    console.log('replicaDetails_$$$', $replicaDetails)
  const peer = new Earthstar.Peer();
  peer.addReplica($replicaDetails.replica);
  const sync = peer.sync(import.meta.env.VITE_SERVER_ADDRESS, true);
  const server = settings.addServer(import.meta.env.VITE_SERVER_ADDRESS);
  console.log(server);

  
  sync.onStatusChange((newStatus) => {
    status = newStatus;
    console.log(newStatus);
    statusStore.set(status);
    console.log('status', status)
  });

  sync
    .isDone()
    .then(() => {
      console.log("Sync complete");
    })
    .catch((err) => {
      console.error("Sync failed", err);
    });
  
  }

  // new peer & syncing with server
  $: if ($replicaDetails) {
    console.log('replicaDetails changed', $replicaDetails);
    createNewPeer();
  }
 

  function handleUpload(event) {
    IDcreated = true;
    showDetails = true;
  }

  function generateID() {
    IDcreated = true;
    showDetails = false;
    showUserSettings = true;
    initialView = 'identity';
  }

  function handleError(event) {
    showWarning = true;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const inStudio = urlParams.has("studio");
  const oracle = urlParams.has("oracle");

  function handleView() {
    imageView = !imageView;
  }

  function toggleUserSettings() {
    showUserSettings = !showUserSettings;
  }

  $: {
    console.log("IDcreated", IDcreated);
    console.log("showDetails", showDetails);
    console.log("imageView", imageView);
  }
</script>

<main>
  <!-- Main APP -->

  <!-- Landing page prompts user to create or reuse ID -->
  {#if !IDcreated && !showDetails}
    <div class="my-12">
      <h1>Eccentric Networks</h1>
      <h4>Collaboration space for the unconnected</h4>
      <div
        class="flex flex-col lg:flex-row items-center mx-16 justify-evenly my-12"
      >
        <button class="phase1 mx-16 mt-12 text-2xl" on:click={generateID}
          >Generate new Identity</button
        >
        <button
          class="phase1 mx-16 mt-12 text-2xl"
          on:click={() => (IDcreated = !IDcreated && showDetails === false)}
          >Explore the commons</button
        >
      </div>
      <div
        class="w-1/2 flex flex-col lg:flex-row items-center mx-2 justify-center my-12"
      >
        <div class="flex flex-row items-center mx-6 my-12">
          <ValidateId
            on:validated={handleUpload}
            on:error={handleError}
            on:generateNewIdentity={() => (IDcreated = !IDcreated)}
            on:alias={handleUpload}
          />
        </div>
      </div>
      <MouseBanner />
    </div>
    {#if showWarning === true}
      <blockquote transition:fly={{ y: 200, duration: 2000 }}>
        There was an error with your identity file
      </blockquote>
    {/if}
  {/if}

  <!-- If ID is created, show the main app -->

  {#if IDcreated && !showUserSettings}
    <div class="w-full">
      <GridView
        on:toggle={toggleUserSettings}
        {showDetails}
        {IDcreated}
        {readManual}
        on:resetManual={() => (readManual = false)}
        on:view={handleView}
        on:details={() => (showUserSettings = true)}
      />
    </div>
  {:else if IDcreated && showUserSettings}
    <div class="w-full">
      <UserSettings on:toggle={toggleUserSettings} {initialView} />
    </div>
  {/if}
</main>
<Footer on:readmanual={handleReadManual} />

<style>
  h1 {
    font-size: var(--font-size-xxl);
  }
  main {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    margin: 0 auto;
    min-width: 100vw;
  }
</style>
